{{> breadcrumbs}}
<h2 class="title is-3">{{#if isNew}}Create New Character{{else}}Edit Character{{/if}}</h2>
{{#unless isNew}}
<div class="buttons">
  <a href="/characters/{{character.id}}/{{encodeURIComponentH character.name}}" class="button is-primary">View Character</a>
</div>
{{/unless}}

<form hx-{{#if isNew}}post{{else}}put{{/if}}="/characters{{#unless isNew}}/{{character.id}}{{/unless}}"
  hx-redirect="{{#if isNew}}/characters{{else}}/characters/{{character.id}}/{{encodeURIComponentH character.name}}{{/if}}">
  <div class="field">
    <label class="label">Name</label>
    <div class="control">
      <input class="input" type="text" name="name" placeholder="Character Name" value="{{character.name}}" required>
    </div>
  </div>

  <div class="field">
    <label class="label">Class</label>
    <div class="control">
      <div class="select">
        <select name="class_id" required>
          <option disabled>Advent Classes</option>
          {{#each adventClasses}}
          <option value="{{this.id}}" {{#if (or (eq ../character.class_id this.id) (eq ../character.class this.name))}}selected{{/if}}>{{this.name}}</option>
          {{/each}}

          <option disabled>Aspirant Preview classes</option>
          {{#each aspirantPreviewClasses}}
          <option value="{{this.id}}" {{#if (or (eq ../character.class_id this.id) (eq ../character.class this.name))}}selected{{/if}}>{{this.name}}</option>
          {{/each}}

          <option disabled>Player Created Classes</option>
          {{#each playerCreatedClasses}}
          <option value="{{this.id}}" {{#if (or (eq ../character.class_id this.id) (eq ../character.class this.name))}}selected{{/if}}>{{this.name}}</option>
          {{/each}}
        </select>
      </div>
    </div>
  </div>

  <div class="field is-grouped">
    <div class="control">
      <label class="label">Level</label>
      <input class="input" type="number" name="level" placeholder="Level"
        value="{{#if character.level}}{{character.level}}{{else}}1{{/if}}" required min="1" max="10">
      {{#if (lt character.level 10)}}
      <p class="help">
        V1: Need {{subtract (getTotalV1MissionsNeeded (add character.level 1)) character.completed_missions}} more
        missions to reach level {{add character.level 1}}<br>
        V2: Need {{subtract (getTotalV2MissionsNeeded (add character.level 1)) character.completed_missions}} more
        missions to reach level {{add character.level 1}}
      </p>
      {{/if}}
    </div>

    <div class="control">
      <label class="label">Completed Missions</label>
      <input class="input" type="number" name="completed_missions" placeholder="Completed Missions"
        value="{{#if character.completed_missions}}{{character.completed_missions}}{{else}}0{{/if}}" required>
    </div>

    <div class="control">
      <label class="label">Commissary Reward</label>
      <input class="input" type="number" name="commissary_reward" placeholder="Commissary Reward"
        value="{{#if character.commissary_reward}}{{character.commissary_reward}}{{else}}0{{/if}}" required>
    </div>
  </div>

  <hr />

  <div class="field">
    <label class="label">Personality</label>
    <div class="columns is-multiline">
      {{#times 3}}
      <div class="column is-one-third">
        <div class="control">
          <label class="label">Trait:</label>
          <div class="select">
            <select name="trait{{@index}}" required>
              {{#each personalityMap}}
              {{#each this}}
              <option value="{{this}}" {{#if (eq (itemAt ../../character.traits @../../index) this)}}selected{{/if}}>
                {{capitalize this}} ({{capitalize @../key}})</option>
              {{/each}}
              {{/each}}
            </select>
          </div>
        </div>
      </div>
      {{/times}}
    </div>
  </div>

  <hr />

  <div class="field">
    <label class="label">Stats</label>
    <div class="columns is-multiline">
      {{#each statList}}
      <div class="column is-one-third">
        <div class="field">
          <label class="label">{{capitalize this}}</label>
          <div class="control">
            <input class="input" type="number" name="{{this}}"
              value="{{#if (lookup ../character this)}}{{lookup ../character this}}{{else}}0{{/if}}" required>
          </div>
        </div>
      </div>
      {{/each}}
    </div>
  </div>

  <hr />

  <div class="block">
    <label class="label">Class Gear</label>
    <div class="columns is-multiline" id="class-gear-list">
      {{#if character.gear}}
      {{#each character.gear}}
      {{> character-class-gear characterGear=this classGearList=../classGearList}}
      {{/each}}
      {{/if}}
    </div>
    <button class="button is-primary" hx-get="/characters/class-gear" hx-target="#class-gear-list"
      hx-swap="beforeend">Add
      Class Gear</button>
  </div>

  <hr />

  <div class="block">
    <label class="label">Common Items</label>
    <div class="columns is-multiline" id="common-items-list">
      {{#if character.common_items}}
      {{#each character.common_items}}
      {{> character-common-item commonItem=this}}
      {{/each}}
      {{/if}}
    </div>
    <button class="button is-primary" hx-get="/characters/common-item" hx-target="#common-items-list"
      hx-swap="beforeend">Add
      Common Item</button>
  </div>

  <hr />

  <div class="field">
    <label class="label">Class Abilities</label>
    <div class="columns is-multiline" id="class-ability-list">
      {{#if character.abilities}}
      {{#each character.abilities}}
      {{> character-class-abilities characterAbility=this classAbilityList=../classAbilityList}}
      {{/each}}
      {{/if}}
    </div>
    <button class="button is-primary" hx-get="/characters/class-abilities" hx-target="#class-ability-list"
      hx-swap="beforeend">Add
      Class Abilities</button>
  </div>

  <hr />

  <div class="field">
    <label class="label">Ability Perks</label>
    <div class="control">
      <textarea class="textarea" name="perks" placeholder="Ability Perks" data-toast-editor>{{character.perks}}</textarea>
    </div>
  </div>

  {{#if character.additional_gear}}
  <hr />

  <div class="field">
    <label class="label">
      Additional Gear
      <span class="tag is-warning is-light ml-2">Deprecated</span>
    </label>
    <p class="help mb-2">This field is deprecated. Please use Common Items above instead.</p>
    <div class="control">
      <textarea class="textarea" name="additional_gear"
        placeholder="Additional Gear" data-toast-editor>{{character.additional_gear}}</textarea>
    </div>
  </div>
  {{/if}}

  <div class="field">
    <label class="label">Image URL</label>
    <div class="control">
      <input class="input" type="url" name="image_url" placeholder="Image URL" value="{{character.image_url}}">
    </div>
    <p class="help">Provide a link; we'll crop how it's displayed without uploading.</p>
  </div>

  <div class="field">
    <label class="label">Image Crop &amp; Preview</label>
    <div class="profile-image-editor" data-image-cropper data-image-input="input[name='image_url']" data-crop-input="input[name='image_crop']">
      <div class="profile-image-editor__canvas">
        <img data-cropper-image src="{{character.image_url}}" alt="Character image cropper">
        <div class="profile-image-editor__placeholder" data-crop-placeholder {{#if character.image_url}}hidden{{/if}}>Add an image URL to start cropping</div>
      </div>
      <div class="profile-image-editor__preview" data-crop-preview aria-label="Character image preview"></div>
    </div>
    <input type="hidden" name="image_crop" value='{{{JSONstringify character.image_crop}}}'>
    <p class="help">Adjust the crop marks to control how the character image renders for viewers.</p>
  </div>

  <div class="field">
    <label class="label">Appearance</label>
    <div class="control">
      <textarea class="textarea" name="appearance"
        placeholder="Character Appearance" data-toast-editor>{{character.appearance}}</textarea>
    </div>
  </div>

  <div class="field">
    <label class="label">Background</label>
    <div class="control">
      <textarea class="textarea" name="background"
        placeholder="Character Background" data-toast-editor>{{character.background}}</textarea>
    </div>
  </div>
  <div class="field">
    <label class="label">Flavor</label>
    <div class="control">
      <textarea class="textarea" name="flavor" placeholder="Character Flavor" data-toast-editor>{{character.flavor}}</textarea>
    </div>
  </div>

  <div class="field">
    <label class="label">Ideas</label>
    <div class="control">
      <textarea class="textarea" name="ideas" placeholder="Character Ideas" data-toast-editor>{{character.ideas}}</textarea>
    </div>
  </div>

  <div class="field">
    <label class="label">Private Notes</label>
    <div class="control">
      <textarea class="textarea" name="private_notes" placeholder="Personal notes (only visible to you)" data-toast-editor>{{character.private_notes}}</textarea>
    </div>
    <p class="help">These notes are private and will only be visible to you.</p>
  </div>

  <hr />

  <div class="field">
    <label class="label">Visibility</label>
    <div class="control">
      <label class="checkbox">
        <input type="checkbox" name="is_public" {{#if character.is_public}}checked{{/if}}>
        Make this character public
      </label>
    </div>
    <div class="control mt-2">
      <label class="checkbox">
        <input type="checkbox" name="hide_from_search" {{#if character.hide_from_search}}checked{{/if}}>
        Hide from public searches (character page still accessible via direct link)
      </label>
    </div>
  </div>

  <hr />

  <div class="buttons is-right">
    {{#unless isNew}}
    <button class="button is-danger" hx-delete="/characters/{{character.id}}"
      hx-confirm="Are you sure you want to delete this character?" hx-redirect="/characters" hx-indicator="this">Delete
      Character</button>
    {{#unless character.is_deceased}}
    <button type="button" class="button is-dark" onclick="document.getElementById('deceased-modal').classList.add('is-active')">
      <span class="icon"><i class="fas fa-skull"></i></span>
      <span>Mark as Deceased</span>
    </button>
    {{/unless}}
    {{/unless}}
    <button class="button {{#if isNew}}is-primary{{else}}is-warning{{/if}}" type="submit" hx-indicator="this">{{#if
      isNew}}Create{{else}}Update{{/if}} Character</button>
  </div>
</form>

<div class="field mt-4">
  <div class="control">
    <a href="/characters" class="button is-light">Cancel</a>
  </div>
</div>

{{#unless isNew}}
{{#unless character.is_deceased}}
<div id="deceased-modal" class="modal">
  <div class="modal-background" onclick="document.getElementById('deceased-modal').classList.remove('is-active')"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Mark Character as Deceased</p>
      <button class="delete" aria-label="close" onclick="document.getElementById('deceased-modal').classList.remove('is-active')"></button>
    </header>
    <form hx-post="/characters/{{character.id}}/deceased" hx-indicator="#deceased-submit">
      <section class="modal-card-body">
        <div class="notification is-danger is-light">
          <p><strong>Warning:</strong> This action is <strong>permanent</strong> and cannot be undone.</p>
          <p class="mt-2">Marking a character as deceased will display a permanent indicator on their profile.</p>
        </div>
        <div class="field">
          <label class="label">To confirm, type the character's name: <strong>{{character.name}}</strong></label>
          <div class="control">
            <input 
              class="input" 
              type="text" 
              name="confirmName" 
              placeholder="Type character name to confirm"
              autocomplete="off"
              data-confirm-name="{{character.name}}"
              oninput="document.getElementById('deceased-submit').disabled = (this.value !== this.dataset.confirmName)"
              required
            >
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button type="button" class="button" onclick="document.getElementById('deceased-modal').classList.remove('is-active')">Cancel</button>
        <button id="deceased-submit" type="submit" class="button is-dark" disabled>
          <span class="icon"><i class="fas fa-skull"></i></span>
          <span>Confirm Death</span>
        </button>
      </footer>
    </form>
  </div>
</div>
{{/unless}}
{{/unless}}
