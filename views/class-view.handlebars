{{> breadcrumbs}}
<h1 class="title is-2">{{class.name}}
  {{#if (eq class.status 'release')}}
  <span class="tag is-success is-light" style="margin-left: 0.5rem;">
    <span class="icon is-small"><i class="fas fa-star"></i></span>
  </span>
  {{/if}}
  {{#if (eq class.status 'beta')}}
  <span class="tag is-warning is-light" style="margin-left: 0.5rem;">
    <span class="icon is-small"><i class="fas fa-flask"></i></span>
    <span>{{class.status}}</span>
  </span>
  {{/if}}
  {{#if (eq class.status 'alpha')}}
  <span class="tag is-danger is-light" style="margin-left: 0.5rem;">
    <span class="icon is-small"><i class="fas fa-flask"></i></span>
    <span>{{class.status}}</span>
  </span>
  {{/if}}
</h1>
{{#if profile}}
{{#or (eq profile.role 'admin') (eq profile.id class.created_by)}}
<div class="buttons">
  <a href="/classes/{{class.id}}/edit" class="button is-warning">Edit</a>
  <button class="button is-danger" hx-delete="/classes/{{class.id}}" hx-target="closest tr"
    hx-swap="outerHTML" hx-confirm="Are you sure you want to delete this class?">Delete</button>
  {{#unless (or (eq class.status 'beta') (eq class.status 'alpha'))}}
  <button class="button is-info" hx-on:click="App.openModal('#unlockCodeModal')">Generate Unlock Code</button>
  {{/unless}}
</div>
{{/or}}
{{/if}}

<div class="columns">
  <div class="column is-one-third">
    {{#if class.image_url}}
    <div class="card mb-4">
      <div class="card-image">
        <div
          class="image-crop-render"
          data-cropped-image
          data-image-src="{{class.image_url}}"
          data-crop-x="{{class.image_crop.x}}"
          data-crop-y="{{class.image_crop.y}}"
          data-crop-width="{{class.image_crop.width}}"
          data-crop-height="{{class.image_crop.height}}"
          role="img"
          aria-label="{{class.name}}"
        ></div>
      </div>
    </div>
    {{/if}}
    <div class="card">
      <div class="card-content">
        <div class="content">
          <h3 class="title is-3">Description</h3>
          <p>{{{markdown class.description}}}</p>
        </div>
        <div class="content">
          <hr>
          <p><strong>Edition: </strong>{{capitalize class.rules_edition}} {{class.rules_version}}</p>
          <p><strong>Public: </strong>{{#if class.is_public}}Yes{{else}}No{{/if}}</p>
          {{#if ownerProfile}}
          {{#if ownerProfile.is_public}}
          <p><strong>Owner: </strong><a href="/profile/view/{{encodeURIComponentH ownerProfile.name}}">{{ownerProfile.name}}</a></p>
          {{else}}
          <p><strong>Owner: </strong>{{ownerProfile.name}}</p>
          {{/if}}
          {{/if}}
        </div>
        {{#if class.pdf_storage_path}}
        <div class="content">
          <hr>
          <h3 class="title is-4">Class PDF</h3>
          {{#if classPdfAccessible}}
          <a class="button is-link is-fullwidth" href="/classes/{{class.id}}/pdf">
            <span class="icon">
              <i class="fas fa-file-pdf"></i>
            </span>
            <span>Open Class PDF</span>
          </a>
          {{else}}
          <div class="notification is-warning is-light">
            Unlock this class to gain access to the PDF.
          </div>
          {{/if}}
          {{#if classPdfError}}
          <p class="help is-danger">{{classPdfError}}</p>
          {{/if}}
        </div>
        {{/if}}
        <div class="content">
        {{#if profile}}
        {{#if class.is_public}}
        {{#if class.is_player_created}}
        {{#or (eq class.status 'alpha') (eq class.status 'beta')}}
        {{#unless unlocked}}
        <div class="buttons is-centered">
          <button class="button is-warning"
            hx-post="/classes/{{class.id}}/unlock/self"
            hx-swap="none"
            hx-on::after-request="if(event.detail.successful){ this.classList.remove('is-primary','is-light'); this.classList.add('is-success'); this.setAttribute('disabled','disabled'); this.textContent='Thanks for helping test!'; }">
            <span class="icon"><i class="fas fa-flask"></i></span>
            <span>Help test this class</span>
          </button>
        </div>
        {{/unless}}
        {{/or}}
        {{/if}}
        {{/if}}
        {{/if}}
        </div>
      </div>
    </div>
    
  </div>
  <div class="columns is-two-thirds">
    <div class="column">
      <div class="card">
        <div class="card-content">
          <div class="content">
            <h3 class="title is-3">Gear</h3>
            <div class="columns">
              <div class="column is-half">
                <p class="has-text-weight-semibold has-text-grey mb-2">Base Gear</p>
              {{#each (first class.gear 3) as |gear|}}
                <div class="card">
                  <div class="card-content">
                    <div class="content">
                      <div class="is-flex is-justify-content-space-between is-align-items-center">
                        <h4 class="title is-4 mb-1">{{gear.name}}</h4>
                        <span class="tag is-info is-light">Base</span>
                      </div>
                      {{{markdown gear.description}}}
                    </div>
                  </div>
                </div>
              {{/each}}
              </div>

              <div class="column is-half">
                <p class="has-text-weight-semibold has-text-grey mb-2">Elective Gear</p>
              {{#each (last class.gear 3) as |gear|}}
                <div class="card">
                  <div class="card-content">
                    <div class="content">
                      <div class="is-flex is-justify-content-space-between is-align-items-center">
                        <h4 class="title is-4 mb-1">{{gear.name}}</h4>
                        <span class="tag is-link is-light">Elective</span>
                      </div>
                      {{{markdown gear.description}}}
                    </div>
                  </div>
                </div>
              {{/each}}
              </div>

            </div>
          </div>
        </div>
      </div>
      <div class="column">
        <div class="card">
          <div class="card-content">
            <div class="content">
              <h3 class="title is-3">Abilities</h3>
              {{#each class.abilities}}
              <div class="card">
                <div class="card-content">
                  <div class="content">
                    <h4 class="title is-4">{{this.name}}</h4>
                    {{{markdown this.description}}}
                  </div>
                </div>
              </div>
              {{/each}}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{{#if profile}}
{{#or (eq profile.role 'admin') (eq profile.id class.creator_id)}}
<!-- Unlock Code Modal -->
<div id="unlockCodeModal" class="modal" data-clear-on-close="true" data-clear-target="#codeResult-{{class.id}}">
  <div class="modal-background" hx-on:click="App.closeModal('#unlockCodeModal')"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Generate Unlock Code for {{class.name}}</p>
      <button class="delete" aria-label="close" hx-on:click="App.closeModal('#unlockCodeModal')"></button>
    </header>
    <section class="modal-card-body">
      <form hx-post="/classes/{{class.id}}/codes" hx-target="#codeResult-{{class.id}}" hx-swap="innerHTML transition:true" hx-disabled-elt="input, button, select, textarea" hx-sync="this:abort" hx-on::after-request="if(event.detail.successful) this.reset()">
        <div class="field">
          <label class="label">Expires At (optional)</label>
          <div class="control">
            <input class="input" type="datetime-local" name="expires_at" placeholder="Leave empty for no expiration">
          </div>
        </div>
        <div class="field">
          <label class="label">Max Uses</label>
          <div class="control">
            <input class="input" type="number" min="1" name="max_uses" value="1" placeholder="Maximum number of times this code can be used">
          </div>
        </div>
        <div class="field">
          <label class="label">Amount</label>
          <div class="control">
            <input class="input" type="number" min="1" name="amount" value="1" placeholder="Number of codes to generate">
          </div>
        </div>
        <div class="field">
          <div class="control">
            <button class="button is-primary" type="submit" hx-indicator="#generateCodeSpinner">
              <span class="icon">
                <i class="fas fa-key"></i>
              </span>
              <span class="is-right">Generate Code(s)</span>
            </button>
            <div id="generateCodeSpinner" class="htmx-indicator">
              <div class="form-loading-spinner"></div>
            </div>
          </div>
        </div>
      </form>
      <div id="codeResult-{{class.id}}" class="mt-4"></div>
    </section>
    <footer class="modal-card-foot">
      <button class="button" hx-on:click="App.closeModal('#unlockCodeModal')">Close</button>
    </footer>
  </div>
</div>

{{/or}}
{{/if}}
