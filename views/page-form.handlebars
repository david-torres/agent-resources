{{> breadcrumbs}}
<div class="level">
  <div class="level-left">
    <h1 class="title is-2">{{#if page}}Edit Page{{else}}Create New Page{{/if}}</h1>
  </div>
  <div class="level-right">
    <a class="button" href="/pages/manage">
      <span class="icon"><i class="fas fa-arrow-left"></i></span>
      <span>Back to Manage</span>
    </a>
  </div>
</div>

<div class="box">
  <form method="post" action="{{#if page}}/pages/{{page.id}}{{else}}/pages{{/if}}" id="page-form">
    <div class="columns">
      <div class="column is-two-thirds">
        <div class="field">
          <label class="label">Title <span class="has-text-danger">*</span></label>
          <div class="control">
            <input class="input" type="text" name="title" id="title" value="{{page.title}}" placeholder="Page Title" required>
          </div>
        </div>
      </div>
      <div class="column is-one-third">
        <div class="field">
          <label class="label">Slug</label>
          <div class="control">
            <input class="input" type="text" name="slug" id="slug" value="{{page.slug}}" placeholder="url-friendly-slug">
          </div>
          <p class="help">Leave empty to auto-generate from title. Must be unique.</p>
        </div>
      </div>
    </div>

    <div class="field">
      <label class="label">Content <span class="has-text-danger">*</span></label>
      <div class="control">
        <textarea class="textarea" name="content" id="content" rows="15" placeholder="Write your page content in Markdown..." data-toast-editor data-editor-height="500px" data-editor-preview="vertical" required>{{page.content}}</textarea>
      </div>
      <p class="help">Supports Markdown formatting. Use <code>**bold**</code>, <code>*italic*</code>, <code># headings</code>, etc.</p>
    </div>

    <div class="columns">
      <div class="column is-one-third">
        <div class="field">
          <label class="label">Access Level</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select name="access_level" id="access_level">
                <option value="public" {{#if (or (not page) (eq page.access_level 'public'))}}selected{{/if}}>Public (Anyone)</option>
                <option value="authenticated" {{#if (eq page.access_level 'authenticated')}}selected{{/if}}>Authenticated (Logged in users)</option>
                <option value="admin" {{#if (eq page.access_level 'admin')}}selected{{/if}}>Admin Only</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      <div class="column is-one-third">
        <div class="field">
          <label class="label">Status</label>
          <div class="control">
            <label class="checkbox">
              <input type="checkbox" name="is_published" id="is_published" {{#if (or (not page) page.is_published)}}checked{{/if}}>
              Published (visible to users)
            </label>
          </div>
          <p class="help">Unpublished pages are only visible to admins.</p>
        </div>
      </div>
    </div>

    <div class="field">
      <div class="buttons">
        <button class="button is-primary" type="submit">
          <span class="icon"><i class="fas fa-save"></i></span>
          <span>{{#if page}}Save Changes{{else}}Create Page{{/if}}</span>
        </button>
        <a class="button" href="/pages/manage">
          Cancel
        </a>
      </div>
    </div>
  </form>
</div>

<script>
// Auto-generate slug from title when title changes and slug is empty
document.addEventListener('DOMContentLoaded', function() {
  const titleInput = document.getElementById('title');
  const slugInput = document.getElementById('slug');
  
  if (titleInput && slugInput) {
    titleInput.addEventListener('input', function() {
      // Only auto-generate if slug is empty or matches the old title-based slug
      if (!slugInput.value || slugInput.dataset.autoGenerated === 'true') {
        const slug = titleInput.value
          .toLowerCase()
          .trim()
          .replace(/[^\w\s-]/g, '')
          .replace(/\s+/g, '-')
          .replace(/-+/g, '-')
          .replace(/^-+|-+$/g, '');
        slugInput.value = slug;
        slugInput.dataset.autoGenerated = 'true';
      }
    });
    
    // Mark slug as manually edited if user types in it
    slugInput.addEventListener('input', function() {
      slugInput.dataset.autoGenerated = 'false';
    });
    
    // Initialize auto-generated flag if slug matches title-based pattern
    if (slugInput.value && titleInput.value) {
      const expectedSlug = titleInput.value
        .toLowerCase()
        .trim()
        .replace(/[^\w\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .replace(/^-+|-+$/g, '');
      if (slugInput.value === expectedSlug) {
        slugInput.dataset.autoGenerated = 'true';
      }
    }
  }
});
</script>
